# 2. 架构设计

## 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
│  ┌──────────────────┐          ┌──────────────────────────┐     │
│  │   Web App         │          │   Electron Desktop App   │     │
│  │   React+Vite      │          │   React + Node Runtime   │     │
│  │   多项目管理       │          │   单项目模式              │     │
│  │   流程可视化编排   │          │   本地Agent执行           │     │
│  └────────┬─────────┘          └────────────┬─────────────┘     │
│           │ WebSocket + REST                 │ WebSocket + REST  │
└───────────┼──────────────────────────────────┼──────────────────┘
            │                                  │
┌───────────┼──────────────────────────────────┼──────────────────┐
│           ▼            API 层                ▼                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              API Server (Node.js + TypeScript)           │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────┐  │    │
│  │  │ Auth     │ │ Project  │ │ Board    │ │ WebSocket │  │    │
│  │  │ Module   │ │ Module   │ │ Module   │ │ Gateway   │  │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └───────────┘  │    │
│  └──────────────────────┬──────────────────────────────────┘    │
│                         │ gRPC                                  │
│  ┌──────────────────────▼──────────────────────────────────┐    │
│  │            Orchestrator (Go)                             │    │
│  │  ┌──────────────┐ ┌──────────────┐ ┌────────────────┐   │    │
│  │  │ Flow Engine  │ │ Task Queue   │ │ Agent Scheduler│   │    │
│  │  │ (DAG执行器)  │ │ (任务调度)    │ │ (Agent分配)    │   │    │
│  │  └──────────────┘ └──────────────┘ └────────────────┘   │    │
│  │  ┌──────────────┐ ┌──────────────┐                      │    │
│  │  │ State Machine│ │ Event Bus    │                      │    │
│  │  │ (状态管理)   │ │ (事件总线)    │                      │    │
│  │  └──────────────┘ └──────────────┘                      │    │
│  └──────────────────────┬──────────────────────────────────┘    │
│                         │ gRPC                                  │
└─────────────────────────┼───────────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────────┐
│                  Agent 执行层                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ClaudeCode│ │  Droid   │ │ Custom   │ │  Human Agent     │   │
│  │ Adapter  │ │  Droid   │ │ Agent    │ │  (人工节点)       │   │
│  │          │ │ Adapter  │ │ Adapter  │ │                  │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
│       │             │            │              │               │
│  ┌────▼─────────────▼────────────▼──────────────▼───────────┐   │
│  │              Agent Runtime Manager                        │   │
│  │  本地进程管理 / 远程容器管理 / 沙箱隔离                     │   │
│  └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────────┐
│                    数据层                                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │PostgreSQL│ │  Redis   │ │  MinIO   │ │  Git Provider    │   │
│  │ 业务数据  │ │ 缓存/队列│ │ 文件存储  │ │ GitHub/GitLab    │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 2.2 服务职责划分

### API Server (Node.js + TypeScript)
- 用户认证与权限管理
- 项目CRUD、看板管理
- WebSocket网关：向前端推送实时状态
- 流程DSL的CRUD与校验
- Git集成（GitHub/GitLab Webhook接收）
- 对外REST API

### Orchestrator (Go)
- 流程引擎核心：DAG解析、节点执行、状态流转
- Agent调度器：根据节点配置分配Agent
- 任务队列管理：并行任务、优先级、重试
- 状态机：流程实例的全生命周期管理
- 事件总线：内部事件分发（节点完成、打回、超时等）

### 通信协议
- 前端 ↔ API Server：REST + WebSocket
- API Server ↔ Orchestrator：gRPC（双向流）
- Orchestrator ↔ Agent Runtime：gRPC（双向流）
- Agent Runtime ↔ 实际Agent进程：stdio/HTTP（取决于Agent类型）

## 2.3 桌面端架构

```
┌─────────────────────────────────────────┐
│          Electron Desktop App            │
│  ┌─────────────────────────────────┐    │
│  │     Renderer (React + Vite)      │    │
│  │     与Web端共享组件库             │    │
│  └──────────────┬──────────────────┘    │
│                 │ IPC                    │
│  ┌──────────────▼──────────────────┐    │
│  │     Main Process (Node.js)       │    │
│  │  ┌───────────┐ ┌─────────────┐  │    │
│  │  │ Local     │ │ Agent       │  │    │
│  │  │ Orch Lite │ │ Runtime     │  │    │
│  │  │ (轻量编排) │ │ (本地进程)   │  │    │
│  │  └───────────┘ └─────────────┘  │    │
│  │  ┌───────────┐ ┌─────────────┐  │    │
│  │  │ Git       │ │ Cloud Sync  │  │    │
│  │  │ Manager   │ │ Client      │  │    │
│  │  └───────────┘ └─────────────┘  │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

桌面端特点：
- 启动时选择项目（从云端同步项目列表）
- 内嵌轻量编排器，可离线执行简单流程
- 本地Agent Runtime直接管理ClaudeCode/Droid进程
- 通过Cloud Sync Client与云端保持状态同步
- 共享Web端的React组件库，UI一致
