name: "openspec-dev-pipeline"
version: "1.0"
description: "基于 OpenSpec 的 Spec 驱动开发流水线：需求 → Spec 规划 → Review → 实施 → Code Review → 归档"

variables:
  project_id: ""
  requirement_text: ""

nodes:
  # ─── 阶段 1：提交需求 ───
  - id: submit_requirement
    name: "提交需求"
    type: human_input
    config:
      form:
        - field: requirement_text
          type: textarea
          label: "需求描述"
          required: true

  # ─── 阶段 1.5：自动生成变更名称 ───
  - id: generate_change_name
    name: "生成变更名称"
    type: agent_task
    agent:
      role: "spec-architect"
    config:
      mode: generate_change_name
      prompt_template: |
        根据以下需求描述，生成一个简短的英文变更名称（slug 格式，用连字符分隔，如 add-dark-mode、fix-login-bug）。

        需求描述：{{nodes.submit_requirement.outputs.requirement_text}}

        要求：
        - 只输出变更名称，不要其他内容
        - 全小写，单词用连字符分隔
        - 简洁准确，不超过5个单词
        - 不要包含 feat/fix 等前缀
    timeout: 30s

  # ─── 阶段 2：Agent 生成 Spec ───
  - id: generate_spec
    name: "Agent 生成 Spec"
    type: agent_task
    agent:
      role: "{{params.spec_role}}"
    config:
      mode: opsx_plan
      opsx:
        change_name: "{{nodes.generate_change_name.outputs.change_name}}"
        schema: "{{params.spec_schema}}"
        init_if_missing: true
      prompt_template: |
        请基于以下需求，使用 OpenSpec 工作流生成完整的规划文档：

        需求描述：{{nodes.submit_requirement.outputs.requirement_text}}

        你需要：
        1. 创建 OpenSpec change: {{nodes.generate_change_name.outputs.change_name}}
        2. 生成 proposal.md（为什么做、做什么、影响范围）
        3. 生成 delta specs：
           - 目录结构镜像 openspec/specs/ 的模块分类
           - 文件名格式：<PREFIX>-YYYY-MM-DD-<capability>.md
           - PREFIX 为 ADDED（新增功能）/ MODIFIED（修改现有功能）/ REMOVED（删除功能）
           - 使用 Given/When/Then 格式描述场景
        4. 生成 design.md（技术方案、数据流、文件变更清单）
        5. 生成 tasks.md（按模块分组的实施任务清单，使用 [ ] 复选框格式）

        请确保所有文件保存到 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/ 目录下。
    timeout: 600s
    retry:
      max_attempts: 2
      backoff: exponential

  # ─── 阶段 3：人工 Review Spec ───
  - id: review_spec
    name: "Review Spec 文档"
    type: human_review
    config:
      review_target: "{{nodes.generate_spec.outputs}}"
      show_artifacts: true
      artifact_paths:
        - "openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/proposal.md"
        - "openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/specs/"
        - "openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/design.md"
        - "openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/tasks.md"
      actions: ["approve", "reject", "edit"]
      timeout: 24h
    on_reject:
      goto: generate_spec
      max_loops: "{{params.max_spec_review_loops}}"
      inject:
        feedback: "{{review.comment}}"

  # ─── 阶段 4：Agent 按 tasks.md 实施代码 ───
  - id: implement_code
    name: "Agent 实施代码"
    type: agent_task
    agent:
      role: "{{params.developer_role}}"
    config:
      mode: opsx_apply
      opsx:
        change_name: "{{nodes.generate_change_name.outputs.change_name}}"
      prompt_template: |
        请按照 OpenSpec 的 tasks.md 实施所有任务。

        变更名称：{{nodes.generate_change_name.outputs.change_name}}

        要求：
        1. 读取 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/tasks.md
        2. 读取 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/design.md
        3. 参考 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/specs/ 中的场景定义
        4. 逐项实施，完成后在 tasks.md 中打勾 [x]
        5. 确保代码符合 design.md 中的技术方案
      git:
        create_branch: true
        branch_pattern: "feat/{{nodes.generate_change_name.outputs.change_name}}"
        auto_commit: true
    timeout: 1200s

  # ─── 阶段 5：Agent Code Review ───
  - id: code_review
    name: "Agent Code Review"
    type: agent_task
    agent:
      role: "{{params.reviewer_role}}"
    config:
      mode: review
      prompt_template: |
        请 Review 以下代码变更，对照 OpenSpec 的 specs 和 design 文档：

        变更名称：{{nodes.generate_change_name.outputs.change_name}}
        Spec 文档目录：openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/

        检查维度：
        1. 完整性：所有 tasks.md 中的任务是否都已实施
        2. 正确性：实施是否符合 specs 中的需求和场景
        3. 一致性：代码是否符合 design.md 中的技术方案
        4. 代码质量：可维护性、安全性、性能
    timeout: 600s

  # ─── 阶段 6：人工最终确认 ───
  - id: final_review
    name: "人工最终确认"
    type: human_review
    config:
      review_target: "{{nodes.code_review.outputs}}"
      show_artifacts: true
      artifact_paths:
        - "openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/"
      actions: ["approve", "reject"]
      timeout: 24h
    on_reject:
      goto: implement_code
      max_loops: "{{params.max_code_review_loops}}"
      inject:
        feedback: "{{review.comment}}"

  # ─── 阶段 7：归档 Spec ───
  - id: archive_spec
    name: "归档 Spec"
    type: agent_task
    agent:
      role: "{{params.spec_role}}"
    config:
      mode: opsx_plan
      opsx:
        change_name: "{{nodes.generate_change_name.outputs.change_name}}"
        action: archive
      prompt_template: |
        请归档已完成的 OpenSpec 变更：{{nodes.generate_change_name.outputs.change_name}}

        操作步骤：
        1. 读取 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/specs/ 下的所有 delta spec 文件
        2. 按照目录结构和文件前缀处理：
           - ADDED-* 文件：去掉 ADDED- 前缀，复制到 openspec/specs/ 对应目录
           - MODIFIED-* 文件：去掉 MODIFIED- 前缀，覆盖 openspec/specs/ 对应文件
           - REMOVED-* 文件：删除 openspec/specs/ 对应文件（文件名去掉 REMOVED- 前缀）
        3. 将 openspec/changes/{{nodes.generate_change_name.outputs.change_name}}/ 移动到 openspec/changes/archive/
        4. 确保 openspec/specs/ 中的内容是最新的完整规范
    timeout: 300s

edges:
  - from: submit_requirement
    to: generate_change_name
  - from: generate_change_name
    to: generate_spec
  - from: generate_spec
    to: review_spec
  - from: review_spec
    to: implement_code
  - from: implement_code
    to: code_review
  - from: code_review
    to: final_review
  - from: final_review
    to: archive_spec
